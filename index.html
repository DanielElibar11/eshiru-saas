<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Eshiru Experience</title>
    <link rel="icon" href="favicon.png" type="image/png">

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; background: black; }
      
      /* Pantalla de Inicio (Overlay) */
      #start-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 9999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white; transition: opacity 0.5s;
      }
      
      #start-btn {
        padding: 15px 40px; font-size: 20px; background: #ff4757; color: white;
        border: none; border-radius: 50px; font-weight: bold; cursor: pointer;
        margin-top: 20px; box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
      }
      
      .hidden { opacity: 0; pointer-events: none; }
    </style>
  </head>
  
  <body>
    <div id="start-screen">
        <h2 id="status">Cargando...</h2>
        <div id="loader" class="spinner-border text-light" role="status">...</div>
        <button id="start-btn" style="display:none">ðŸ”¥ VER EXPERIENCIA ðŸ”¥</button>
    </div>

    <div id="ar-container"></div>

    <script>
      // â¬‡ï¸ TU CONFIGURACIÃ“N DE FIREBASE â¬‡ï¸
      const firebaseConfig = {
      apiKey: "AIzaSyDjjMQH62cIao0FyVpM0l2hAg-yQrsZItk",
      authDomain: "eshiru-app.firebaseapp.com",
      projectId: "eshiru-app",
      storageBucket: "eshiru-app.firebasestorage.app",
      messagingSenderId: "392199103888",
      appId: "1:392199103888:web:ef45f6ea5f194ab81fff15"
      };
      // â¬†ï¸ ------------------------------------- â¬†ï¸

      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      document.addEventListener("DOMContentLoaded", async function() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const status = document.getElementById('status');
        const startBtn = document.getElementById('start-btn');
        const loader = document.getElementById('loader');
        const startScreen = document.getElementById('start-screen');

        if (!id) { status.innerText = "âš ï¸ Error: Falta ID."; return; }

        try {
            // 1. Descarga de datos
            const doc = await db.collection("productos").doc(id).get();
            if (!doc.exists) { status.innerText = "âŒ No encontrado."; return; }
            const data = doc.data();

            status.innerText = "Â¡Listo!";
            loader.style.display = 'none';
            startBtn.style.display = 'block';

            // 2. Al dar clic, desbloqueamos audio pero NO reproducimos aÃºn
            startBtn.addEventListener('click', () => {
                startScreen.classList.add('hidden');
                iniciarAR(data);
            });

        } catch (error) {
            console.error(error);
            status.innerText = "Error: " + error.message;
        }
      });

      function iniciarAR(data) {
          // Construimos la escena
          const sceneHTML = `
            <a-scene mindar-image="imageTargetSrc: ${data.target}; filterMinCF:0.001; filterBeta: 10; uiLoading:no; uiScanning:yes;" 
                     color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" 
                     vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
                
                <a-assets>
                    <video id="vid" src="https://cdn.aframe.io/videos/bunny.mp4" 
                     preload="auto" loop="true" playsinline webkit-playsinline crossorigin="anonymous"></video>
                </a-assets>

                <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

                <a-entity mindar-image-target="targetIndex: 0">
                    <a-plane src="#vid" position="0 0 0" height="1.77" width="1" rotation="0 0 0" 
                             material="shader: flat; opacity: 1"></a-plane>
                </a-entity>
            </a-scene>
          `;

          document.getElementById('ar-container').innerHTML = sceneHTML;

          setTimeout(() => {
              const vid = document.querySelector('#vid');
              const scene = document.querySelector('a-scene');

              // Truco para 'calentar' el video (Play 1ms y Pause)
              vid.play().then(() => {
                  vid.pause();
                  vid.currentTime = 0;
              }).catch(e => console.log("Esperando interacciÃ³n..."));

              // ðŸ”Š REGLA DE ORO: Solo suena si ve la imagen
              scene.addEventListener("targetFound", () => { 
                  console.log("Â¡Goku encontrado!");
                  vid.muted = false; // Activar sonido
                  vid.play();        // Arrancar video
              });

              scene.addEventListener("targetLost", () => { 
                  console.log("Goku perdido...");
                  vid.pause();       // Pausar video
                  // vid.currentTime = 0; // Opcional: Reiniciar al perder
              });
              
          }, 1000);
      }
    </script>
  </body>
</html>

