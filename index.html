<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Eshiru Experience</title>
    <link rel="icon" href="favicon.png" type="image/png">

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; background-color: black; }
      #loading-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 9999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white;
      }
      .hidden { display: none !important; }
      #debug-link {
        margin-top: 20px; color: #ff4757; font-size: 12px; text-decoration: underline; cursor: pointer;
      }
    </style>
  </head>
  
  <body>
    <div id="loading-screen">
        <h2 id="status">Buscando producto...</h2>
        <div class="spinner-border text-light" role="status"></div>
        <a id="debug-link" href="#" target="_blank" style="display:none">Ver archivo (Debug)</a>
    </div>

    <div id="ar-container"></div>

    <script>
      // ⬇️ TU CONFIGURACIÓN DE FIREBASE ⬇️
      const firebaseConfig = {
      apiKey: "AIzaSyDjjMQH62cIao0FyVpM0l2hAg-yQrsZItk",
      authDomain: "eshiru-app.firebaseapp.com",
      projectId: "eshiru-app",
      storageBucket: "eshiru-app.firebasestorage.app",
      messagingSenderId: "392199103888",
      appId: "1:392199103888:web:ef45f6ea5f194ab81fff15"
      };
      // ⬆️ ------------------------------------- ⬆️

      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      document.addEventListener("DOMContentLoaded", async function() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const status = document.getElementById('status');
        const debugLink = document.getElementById('debug-link');

        if (!id) { status.innerText = "⚠️ Error: Falta ID."; return; }

        try {
            status.innerText = "Cargando...";
            const doc = await db.collection("productos").doc(id).get();
            
            if (!doc.exists) { status.innerText = "❌ No encontrado."; return; }
            
            const data = doc.data();
            
            debugLink.href = data.target;
            debugLink.style.display = 'block';

            console.log("Video URL:", data.targetVideo || data.video);
            status.innerText = "Iniciando cámara...";

            // ⚠️ AQUÍ ESTÁ LA SOLUCIÓN DEL VIDEO INVISIBLE ⚠️
            // 1. Usamos <a-video> en lugar de <a-plane>
            // 2. Quitamos la opacidad y forzamos el shader flat
            const sceneHTML = `
            <a-scene mindar-image="imageTargetSrc: ${data.target}; filterMinCF:0.001; filterBeta: 10; uiLoading:no; uiScanning:yes;" 
                     color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" 
                     vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
                
                <a-assets>
                    <video id="vid" src="${data.targetVideo || data.video}" 
                           preload="auto" loop="true" playsinline webkit-playsinline crossorigin="anonymous" 
                           autoplay muted></video>
                </a-assets>

                <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

                <a-entity mindar-image-target="targetIndex: 0">
                    <a-video src="#vid" position="0 0 0" height="1.77" width="1" rotation="0 0 0"></a-video>
                </a-entity>
            </a-scene>
            `;

            document.getElementById('ar-container').innerHTML = sceneHTML;
            
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
                
                const vid = document.querySelector('#vid');
                const scene = document.querySelector('a-scene');
                
                // Forzar reproducción al detectar
                scene.addEventListener("targetFound", () => { 
                    console.log("Target Found! Playing video...");
                    vid.muted = false; 
                    // Truco sucio: Pausar y Play rápido para forzar repintado
                    vid.pause();
                    setTimeout(() => vid.play(), 50);
                });
                
                scene.addEventListener("targetLost", () => { 
                    vid.pause(); 
                });
                
                // Click de respaldo
                document.body.addEventListener('click', () => { 
                    vid.play(); 
                    vid.muted = false; 
                });
                
            }, 2500);

        } catch (error) {
            console.error(error);
            status.innerText = "Error: " + error.message;
        }
      });
    </script>
  </body>
</html>
