<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Debug Laptop</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; background: black; color: white; font-family: monospace; }
      #debug-console {
        position: fixed; top: 0; left: 0; width: 100%; padding: 10px;
        background: rgba(0,0,0,0.8); z-index: 9999; pointer-events: none;
        white-space: pre-wrap; font-size: 12px;
      }
      #start-btn {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        padding: 15px 30px; background: red; color: white; border: none; z-index: 10000;
        font-size: 16px; cursor: pointer; display: none;
      }
    </style>
  </head>
  
  <body>
    <div id="debug-console">Iniciando sistema...</div>
    <button id="start-btn">‚ñ∂Ô∏è ACTIVAR CAMARA</button>
    <div id="ar-container"></div>

    <script>
      // ‚¨áÔ∏è TU CONFIG ‚¨áÔ∏è
      const firebaseConfig = {
      apiKey: "AIzaSyDjjMQH62cIao0FyVpM0l2hAg-yQrsZItk",
      authDomain: "eshiru-app.firebaseapp.com",
      projectId: "eshiru-app",
      storageBucket: "eshiru-app.firebasestorage.app",
      messagingSenderId: "392199103888",
      appId: "1:392199103888:web:ef45f6ea5f194ab81fff15"
      };
      // ‚¨ÜÔ∏è --------- ‚¨ÜÔ∏è

      function log(msg) {
          console.log(msg);
          document.getElementById('debug-console').innerText += "\n" + msg;
      }

      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      document.addEventListener("DOMContentLoaded", async function() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');

        if (!id) return log("‚ùå Error: Falta ID en la URL");

        try {
            log("1. Buscando en Firebase...");
            const doc = await db.collection("productos").doc(id).get();
            if (!doc.exists) return log("‚ùå ID no existe en Base de Datos");
            
            const data = doc.data();
            const videoUrl = data.targetVideo || data.video;
            log("‚úÖ Datos encontrados.");
            log("2. URL Video: " + videoUrl.substring(0, 30) + "...");

            // INTENTO DE DESCARGA DIRECTA (Bypass CORS)
            log("3. Descargando archivo de video...");
            
            const response = await fetch(videoUrl, { mode: 'cors' });
            if (!response.ok) throw new Error("Error red: " + response.status);
            
            const blob = await response.blob();
            const localUrl = URL.createObjectURL(blob);
            log("‚úÖ Video descargado en RAM: " + localUrl);

            // Mostrar bot√≥n
            const btn = document.getElementById('start-btn');
            btn.style.display = 'block';
            
            btn.addEventListener('click', () => {
                btn.style.display = 'none';
                log("4. Iniciando AR...");
                iniciarAR(data.target, localUrl);
            });

        } catch (e) {
            log("‚ùå ERROR CR√çTICO: " + e.message);
        }
      });

      function iniciarAR(targetUrl, videoUrl) {
          const sceneHTML = `
            <a-scene mindar-image="imageTargetSrc: ${targetUrl}; filterMinCF:0.001; filterBeta: 10;" 
                     color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" 
                     vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
                
                <a-assets>
                    <video id="vid" src="${videoUrl}" loop="true" playsinline webkit-playsinline crossorigin="anonymous"></video>
                </a-assets>

                <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

                <a-entity mindar-image-target="targetIndex: 0">
                    <a-plane src="#vid" position="0 0 0" height="1.77" width="1" rotation="0 0 0" 
                             material="shader: flat; opacity: 1"></a-plane>
                </a-entity>
            </a-scene>
          `;
          document.getElementById('ar-container').innerHTML = sceneHTML;
          
          setTimeout(() => {
              const vid = document.querySelector('#vid');
              const scene = document.querySelector('a-scene');

              // Forzar carga de textura
              vid.play().then(() => vid.pause());

              scene.addEventListener("targetFound", () => { 
                  log("üéØ IMAGEN ENCONTRADA");
                  vid.muted = false; 
                  vid.play();
              });
              scene.addEventListener("targetLost", () => { 
                  log("üí® Perdido");
                  vid.pause(); 
              });
          }, 1000);
      }
    </script>
  </body>
</html>
