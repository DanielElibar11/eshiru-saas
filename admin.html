<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eshiru Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="card shadow">
            <div class="card-header bg-dark text-white text-center">
                <h3>üé¥ Eshiru Manager</h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="fw-bold">ID del Producto (Sin espacios)</label>
                    <input type="text" id="productId" class="form-control" placeholder="ej: goku-01">
                </div>
                <div class="row">
                    <div class="col-6 mb-3">
                        <label>Target (.mind)</label>
                        <input type="file" id="mindFile" class="form-control" accept=".mind">
                    </div>
                    <div class="col-6 mb-3">
                        <label>Video (.mp4)</label>
                        <input type="file" id="videoFile" class="form-control" accept="video/mp4">
                    </div>
                </div>
                <button onclick="subirTodo()" id="btnAction" class="btn btn-primary w-100 btn-lg">üöÄ Subir a la Nube</button>
                
                <div id="loader" class="mt-3 text-center" style="display:none;">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Subiendo archivos y generando base de datos...</p>
                </div>

                <div id="result" class="mt-4 text-center border-top pt-3" style="display:none;">
                    <h4 class="text-success">¬°Creado con √©xito!</h4>
                    <div id="qrcode" class="d-flex justify-content-center my-3"></div>
                    <a id="linkFinal" href="#" target="_blank" class="btn btn-outline-dark btn-sm">Abrir Enlace</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <script>
        // ‚¨áÔ∏è‚¨áÔ∏è PEGA AQU√ç TU CONFIG DE FIREBASE ‚¨áÔ∏è‚¨áÔ∏è
        const firebaseConfig = {
        apiKey: "AIzaSyDjjMQH62cIao0FyVpM0l2hAg-yQrsZItk",
        authDomain: "eshiru-app.firebaseapp.com",
        projectId: "eshiru-app",
        storageBucket: "eshiru-app.firebasestorage.app",
        messagingSenderId: "392199103888",
        appId: "1:392199103888:web:ef45f6ea5f194ab81fff15"
        };
        // ‚¨ÜÔ∏è‚¨ÜÔ∏è ---------------------------------- ‚¨ÜÔ∏è‚¨ÜÔ∏è

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        async function subirTodo() {
            const id = document.getElementById('productId').value.trim();
            const mindFile = document.getElementById('mindFile').files[0];
            const videoFile = document.getElementById('videoFile').files[0];
            const btn = document.getElementById('btnAction');
            const loader = document.getElementById('loader');

            if (!id || !mindFile || !videoFile) return alert("Faltan datos");

            btn.disabled = true;
            loader.style.display = 'block';

            try {
                // 1. Subir Target
                const mindRef = storage.ref(`targets/${id}.mind`);
                await mindRef.put(mindFile);
                const mindUrl = await mindRef.getDownloadURL();

                // 2. Subir Video
                const videoRef = storage.ref(`videos/${id}.mp4`);
                await videoRef.put(videoFile);
                const videoUrl = await videoRef.getDownloadURL();

                // 3. Guardar DB
                await db.collection("productos").doc(id).set({
                    target: mindUrl,
                    video: videoUrl,
                    fecha: new Date()
                });

                // 4. Generar Link y QR
                // OJO: Esta URL cambiar√° cuando lo subas a GitHub, detectamos la actual
                const baseURL = window.location.href.replace('admin.html', 'index.html');
                const finalUrl = `${baseURL}?id=${id}`;

                document.getElementById('qrcode').innerHTML = "";
                new QRCode(document.getElementById("qrcode"), finalUrl);
                document.getElementById('linkFinal').href = finalUrl;
                document.getElementById('result').style.display = 'block';

            } catch (e) {
                alert("Error: " + e.message);
                console.error(e);
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        }
    </script>
</body>
</html>