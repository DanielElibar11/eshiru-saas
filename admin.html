<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eshiru Admin - Panel Maestro</title>
    <link rel="icon" href="favicon.png" type="image/png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h3 class="mb-0">üé¥ Eshiru Manager v3.0</h3>
            <span class="badge bg-success">Online üü¢</span>
        </div>
        
        <div class="card-body p-4">
            
            <div class="alert alert-warning border-warning shadow-sm">
                <h5 class="fw-bold text-dark">üõë ¬°ALTO! Sigue estos pasos antes de subir nada:</h5>
                <ol class="mb-3">
                    <li class="mb-2">
                        Entra al <strong>Compilador</strong> y sube tu imagen (JPG/PNG).
                        <br>
                        <a href="https://hiukim.github.io/mind-ar-js-doc/tools/compile" target="_blank" class="btn btn-primary btn-sm mt-1">
                            üñºÔ∏è Ir al Compilador .MIND
                        </a>
                    </li>
                    <li>
                        Espera a que termine y dale a <strong>"Download targets.mind"</strong>.
                        <br>
                        <em>Ese archivo que descargues es el que debes subir abajo. ¬°No subas la imagen original!</em>
                    </li>
                </ol>
                <hr>
                 <div class="d-flex align-items-center gap-2">
                    <span>¬øVideo muy pesado?</span>
                    <a href="https://online-video-cutter.com/es/" target="_blank" class="btn btn-outline-danger btn-sm">
                        üé¨ Cortar Video Aqu√≠
                    </a>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12 mb-3">
                    <label class="fw-bold form-label">Nuevo ID (Sin espacios)</label>
                    <input type="text" id="productId" class="form-control form-control-lg" placeholder="Ej: goku-final-v2">
                </div>

                <div class="col-md-6 mb-3">
                    <div class="card p-3 border-primary h-100">
                        <label class="form-label fw-bold text-primary">üìÇ 1. Archivo TARGET (.mind)</label>
                        <input type="file" id="mindFile" class="form-control" accept=".mind">
                        <small class="text-muted d-block mt-2">Sube aqu√≠ el archivo <code>targets.mind</code> que descargaste.</small>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <div class="card p-3 border-danger h-100">
                        <label class="form-label fw-bold text-danger">üé¨ 2. Archivo VIDEO (.mp4)</label>
                        <input type="file" id="videoFile" class="form-control" accept="video/mp4">
                        <small class="text-muted d-block mt-2">Sube aqu√≠ tu video MP4.</small>
                    </div>
                </div>
            </div>

            <button onclick="subirTodo()" id="btnAction" class="btn btn-dark w-100 btn-lg mt-3 py-3 fw-bold">
                üöÄ SUBIR Y CREAR QR
            </button>
            
            <div id="loader" class="mt-4 text-center" style="display:none;">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
                <p class="mt-3 fw-bold text-primary">Subiendo... Paciencia...</p>
            </div>

            <div id="result" class="mt-5 text-center border rounded p-4 bg-white shadow-sm" style="display:none;">
                <h2 class="text-success fw-bold">‚úÖ ¬°Listo!</h2>
                <div class="d-flex justify-content-center my-3">
                    <div id="qrcode" class="p-3 bg-white border shadow-sm"></div>
                </div>
                <div class="input-group mb-3">
                    <span class="input-group-text">Link</span>
                    <input type="text" id="linkFinalInput" class="form-control" readonly>
                    <a id="linkFinalBtn" href="#" target="_blank" class="btn btn-outline-primary">Probar</a>
                </div>
                <button onclick="location.reload()" class="btn btn-secondary btn-sm mt-2">Nuevo Producto</button>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<script>
    // ‚¨áÔ∏è‚¨áÔ∏è ‚ö†Ô∏è PEGA AQU√ç TU CONFIG DE FIREBASE ‚ö†Ô∏è ‚¨áÔ∏è‚¨áÔ∏è
    const firebaseConfig = {
        apiKey: "AIzaSyDjjMQH62cIao0FyVpM0l2hAg-yQrsZItk",
        authDomain: "eshiru-app.firebaseapp.com",
        projectId: "eshiru-app",
        storageBucket: "eshiru-app.firebasestorage.app",
        messagingSenderId: "392199103888",
        appId: "1:392199103888:web:ef45f6ea5f194ab81fff15"
        };
    // ‚¨ÜÔ∏è‚¨ÜÔ∏è ------------------------------------ ‚¨ÜÔ∏è‚¨ÜÔ∏è

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.firestore();
    const storage = firebase.storage();

    async function subirTodo() {
        const id = document.getElementById('productId').value.trim();
        const mindFile = document.getElementById('mindFile').files[0];
        const videoFile = document.getElementById('videoFile').files[0];
        const btn = document.getElementById('btnAction');
        const loader = document.getElementById('loader');

        if (!id) return alert("‚ùå Falta el ID.");
        if (!mindFile) return alert("‚ùå Falta el archivo .mind");
        if (!videoFile) return alert("‚ùå Falta el video .mp4");

        // Validaci√≥n extra de seguridad
        if (!mindFile.name.endsWith('.mind')) {
            return alert("‚õî ERROR CR√çTICO: El archivo target debe terminar en .mind\n\nEst√°s intentando subir: " + mindFile.name + "\n\nPor favor usa el COMPILADOR (Bot√≥n azul) primero.");
        }

        btn.disabled = true;
        loader.style.display = 'block';
        document.getElementById('result').style.display = 'none';

        try {
            // 1. Subir Target
            const mindRef = storage.ref(`targets/${id}.mind`);
            await mindRef.put(mindFile);
            const mindUrl = await mindRef.getDownloadURL();

            // 2. Subir Video
            const videoRef = storage.ref(`videos/${id}.mp4`);
            await videoRef.put(videoFile);
            const videoUrl = await videoRef.getDownloadURL();

            // 3. Guardar DB
            await db.collection("productos").doc(id).set({
                target: mindUrl,
                video: videoUrl,
                fecha: new Date(),
                creador: "Admin Panel v3"
            });

            // 4. Generar URL limpia
            let baseURL = window.location.href;
            baseURL = baseURL.replace('/admin.html', '').replace('/admin', ''); 
            if (baseURL.endsWith('/')) baseURL = baseURL.slice(0, -1);
            
            const finalUrl = `${baseURL}/?id=${id}`;

            // 5. QR
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: finalUrl,
                width: 200,
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            
            document.getElementById('linkFinalInput').value = finalUrl;
            document.getElementById('linkFinalBtn').href = finalUrl;
            document.getElementById('result').style.display = 'block';

        } catch (e) {
            console.error(e);
            alert("‚ùå Error: " + e.message);
        } finally {
            btn.disabled = false;
            loader.style.display = 'none';
        }
    }
</script>
</body>
</html>
