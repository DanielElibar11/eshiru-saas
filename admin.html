<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eshiru Admin - Panel Maestro</title>
    <link rel="icon" href="favicon.png" type="image/png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <h3 class="mb-0">üé¥ Eshiru Manager</h3>
            </div>
            <span class="badge bg-success">Online üü¢</span>
        </div>
        
        <div class="card-body p-4">
            
            <div class="alert alert-secondary shadow-sm">
                <h6 class="fw-bold mb-2">üîß Herramientas de Creaci√≥n:</h6>
                <div class="d-flex gap-2 flex-wrap">
                    <a href="https://hiukim.github.io/mind-ar-js-doc/tools/compile" target="_blank" class="btn btn-primary btn-sm">
                        üñºÔ∏è 1. Crear archivo .MIND
                    </a>
                    <a href="https://online-video-cutter.com/es/" target="_blank" class="btn btn-danger btn-sm">
                        üé¨ 2. Editar/Comprimir Video
                    </a>
                </div>
                <small class="text-muted mt-1 d-block">Usa estas herramientas antes de subir los archivos abajo.</small>
            </div>
            <hr>
            <div class="mb-4">
                <label class="fw-bold form-label">ID del Producto (Sin espacios)</label>
                <input type="text" id="productId" class="form-control form-control-lg" placeholder="Ej: goku-final-v1">
                <div class="form-text">Este ID ser√° √∫nico para cada cliente.</div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Archivo Target (.mind)</label>
                    <input type="file" id="mindFile" class="form-control" accept=".mind">
                    <small class="text-muted">El archivo que descargaste del bot√≥n azul.</small>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Video AR (.mp4)</label>
                    <input type="file" id="videoFile" class="form-control" accept="video/mp4">
                    <small class="text-muted">Video mp4 (recomendado: sin audio o corto).</small>
                </div>
            </div>

            <button onclick="subirTodo()" id="btnAction" class="btn btn-dark w-100 btn-lg mt-3 py-3">
                üöÄ Subir a la Nube y Generar QR
            </button>
            
            <div id="loader" class="mt-4 text-center" style="display:none;">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
                <p class="mt-3 fw-bold text-primary">Subiendo archivos a Firebase...<br>No cierres esta ventana.</p>
            </div>

            <div id="result" class="mt-5 text-center border rounded p-4 bg-white shadow-sm" style="display:none;">
                <h2 class="text-success fw-bold">‚úÖ ¬°Experiencia Creada!</h2>
                <p class="text-muted">Imprime este QR o env√≠alo a tu cliente.</p>
                
                <div class="d-flex justify-content-center my-3">
                    <div id="qrcode" class="p-3 bg-white border shadow-sm"></div>
                </div>
                
                <div class="input-group mb-3">
                    <span class="input-group-text">Enlace Cliente</span>
                    <input type="text" id="linkFinalInput" class="form-control" readonly>
                    <a id="linkFinalBtn" href="#" target="_blank" class="btn btn-outline-primary">Abrir</a>
                </div>
                <button onclick="location.reload()" class="btn btn-secondary btn-sm mt-2">Crear Nuevo Producto</button>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<script>
    // ‚¨áÔ∏è‚¨áÔ∏è ‚ö†Ô∏è IMPORTANTE: PEGA AQU√ç TU CONFIGURACI√ìN DE FIREBASE ‚¨áÔ∏è‚¨áÔ∏è
    const firebaseConfig = {
        apiKey: "AIzaSyDjjMQH62cIao0FyVpM0l2hAg-yQrsZItk",
        authDomain: "eshiru-app.firebaseapp.com",
        projectId: "eshiru-app",
        storageBucket: "eshiru-app.firebasestorage.app",
        messagingSenderId: "392199103888",
        appId: "1:392199103888:web:ef45f6ea5f194ab81fff15"
        };
    // ‚¨ÜÔ∏è‚¨ÜÔ∏è ----------------------------------------------------------- ‚¨ÜÔ∏è‚¨ÜÔ∏è

    // Inicializar Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const storage = firebase.storage();

    async function subirTodo() {
        const id = document.getElementById('productId').value.trim();
        const mindFile = document.getElementById('mindFile').files[0];
        const videoFile = document.getElementById('videoFile').files[0];
        const btn = document.getElementById('btnAction');
        const loader = document.getElementById('loader');

        // Validaci√≥n simple
        if (!id) return alert("‚ùå Escribe un ID para el producto.");
        if (!mindFile) return alert("‚ùå Falta el archivo .mind");
        if (!videoFile) return alert("‚ùå Falta el video .mp4");

        // Bloquear interfaz
        btn.disabled = true;
        loader.style.display = 'block';
        document.getElementById('result').style.display = 'none';

        try {
            console.log("Iniciando subida para ID:", id);

            // 1. Subir Target (.mind)
            const mindRef = storage.ref(`targets/${id}.mind`);
            await mindRef.put(mindFile);
            const mindUrl = await mindRef.getDownloadURL();
            console.log("Target subido:", mindUrl);

            // 2. Subir Video (.mp4)
            const videoRef = storage.ref(`videos/${id}.mp4`);
            await videoRef.put(videoFile);
            const videoUrl = await videoRef.getDownloadURL();
            console.log("Video subido:", videoUrl);

            // 3. Guardar Referencia en Base de Datos
            await db.collection("productos").doc(id).set({
                target: mindUrl,
                video: videoUrl,
                fecha: new Date(),
                creador: "Admin Panel"
            });

            // 4. Generar Enlace Limpio
            // Detecta la URL actual y le quita "admin.html" para dejar solo la ra√≠z
            let baseURL = window.location.href;
            baseURL = baseURL.replace('/admin.html', '').replace('/admin', '');
            if (baseURL.endsWith('/')) baseURL = baseURL.slice(0, -1); // Quitar slash final si sobra
            
            const finalUrl = `${baseURL}/?id=${id}`;

            // 5. Generar C√≥digo QR
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: finalUrl,
                width: 200,
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            
            // Mostrar Resultado
            document.getElementById('linkFinalInput').value = finalUrl;
            document.getElementById('linkFinalBtn').href = finalUrl;
            document.getElementById('result').style.display = 'block';

        } catch (e) {
            console.error("Error cr√≠tico:", e);
            alert("‚ùå Ocurri√≥ un error: " + e.message + "\n\nRevisa la consola (F12) para m√°s detalles.");
        } finally {
            btn.disabled = false;
            loader.style.display = 'none';
        }
    }
</script>
</body>
</html>
